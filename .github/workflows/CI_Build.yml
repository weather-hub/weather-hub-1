name: Advanced Docker Build Workflow

on:
  push:
    branches:
      - main
      - trunk
  pull_request:
    branches:
      - main
      - trunk

jobs:
  build:
    name: Build & Test Docker Image
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Clonar repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Build de la imagen Docker
      - name: Build Docker image
        run: |
          docker build \
            -f docker/images/Dockerfile.render \
            -t mi-app-ci:${{ github.sha }} .

      # 3️⃣ Ejecutar un contenedor de prueba
      - name: Run Docker container to validate
        run: |
          CONTAINER_ID=$(docker run -d mi-app-ci:${{ github.sha }})
          # Esperar 10 segundos para que el contenedor inicialice
          sleep 10
          # Comprobar que el contenedor sigue corriendo
          if [ "$(docker inspect -f '{{.State.Running}}' $CONTAINER_ID)" != "true" ]; then
            echo "ERROR: El contenedor no se inició correctamente"
            docker logs $CONTAINER_ID
            docker rm -f $CONTAINER_ID
            exit 1
          fi
          echo "Contenedor iniciado correctamente"
          # Detener y eliminar contenedor de prueba
          docker rm -f $CONTAINER_ID
