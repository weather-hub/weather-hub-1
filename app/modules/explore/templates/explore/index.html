{% extends "base_template.html" %}

{% block title %}Explore{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
  <div class="row g-3">
    <!-- Resultados -->
    <div class="col-lg-8 col-xl-8 pe-lg-2">
      <h1 class="h3 mb-3">Explore</h1>
      <h3 class="h5 mb-4">
        <span id="results_number">{{ datasets|length }} {{ 'dataset' if datasets|length == 1 else 'datasets' }} found</span>
      </h3>

      {% if datasets %}
        {% for ds in datasets %}
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <h4 class="mb-1">{{ ds.ds_meta_data.title }}</h4>
                <span class="badge text-bg-light">{{ ds.get_cleaned_publication_type() }}</span>
              </div>
              <small class="text-muted d-block mb-2">
                {{ ds.created_at.strftime('%d %b %Y, %H:%M') }}
              </small>
              <p class="mb-2">
                {{ ds.ds_meta_data.description[:250] }}{% if ds.ds_meta_data.description|length > 250 %}…{% endif %}
              </p>
              {% if ds.ds_meta_data.tags %}
                <div class="mt-2">
                  {% for tag in ds.ds_meta_data.tags.split(',') %}
                    <span class="badge bg-primary-subtle text-primary-emphasis me-1">{{ tag.strip() }}</span>
                  {% endfor %}
                </div>
              {% endif %}
              <div class="mt-3">
                <a href="{{ ds.get_uvlhub_doi() }}" class="btn btn-outline-primary btn-sm">View dataset</a>
                <a href="{{ url_for('dataset.download_dataset', dataset_id=ds.id) }}" class="btn btn-outline-primary btn-sm">Download ({{ ds.get_file_total_size_for_human() }})</a>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center text-muted py-5">No datasets found for the selected filters.</div>
      {% endif %}
    </div>

    <!-- Filtros -->
    <div class="col-lg-4 col-xl-4 ps-lg-2 d-none d-lg-block">
      <div class="card position-sticky" style="top: 85px;">
        <div class="card-body">
          <form method="get" action="{{ url_for('explore.index') }}" id="filters-side-form">
            <!-- Search -->
            <div class="mb-3">
              <input type="text" name="query" value="{{ query or '' }}" class="form-control" placeholder="Search datasets…">
            </div>

            <!-- Publication type -->
            <div class="mb-3">
              <label class="form-label">Publication type</label>
              <select name="publication_type" class="form-select">
                <option value="any" {{ 'selected' if request_args.get('publication_type','any')=='any' }}>Any</option>
                {% set pub_opts = [
                  ('annotationcollection','Annotation Collection'),
                  ('book','Book'),
                  ('section','Book Section'),
                  ('conferencepaper','Conference Paper'),
                  ('datamanagementplan','Data Management Plan'),
                  ('article','Journal Article'),
                  ('patent','Patent'),
                  ('preprint','Preprint'),
                  ('deliverable','Project Deliverable'),
                  ('milestone','Project Milestone'),
                  ('proposal','Proposal'),
                  ('report','Report'),
                  ('softwaredocumentation','Software Documentation'),
                  ('taxonomictreatment','Taxonomic Treatment'),
                  ('technicalnote','Technical Note'),
                  ('thesis','Thesis'),
                  ('workingpaper','Working Paper'),
                  ('other','Other'),
                  ('none','None')
                ] %}
                {% for val, lbl in pub_opts %}
                  <option value="{{ val }}" {{ 'selected' if request_args.get('publication_type')==val }}>{{ lbl }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Tags -->
            <div class="mb-3">
              <label class="form-label">Tags</label>
              <input type="text" name="tags" value="{{ request_args.get('tags','') }}" class="form-control" placeholder="Enter tags separated by commas">
            </div>

            <!-- Date range -->
            <div class="mb-3">
              <label class="form-label d-block">Creation date</label>
              <div class="d-flex gap-2">
                <input type="date" name="start_date" class="form-control" value="{{ request_args.get('start_date','') }}">
                <input type="date" name="end_date" class="form-control" value="{{ request_args.get('end_date','') }}">
              </div>
            </div>

            <!-- Sort -->
            <div class="mb-4">
              <label class="form-label">Sort by</label>
              <select name="sort_by" class="form-select">
                <option value="newest" {{ 'selected' if request_args.get('sort_by','newest')=='newest' }}>Newest first</option>
                <option value="oldest" {{ 'selected' if request_args.get('sort_by')=='oldest' }}>Oldest first</option>
              </select>
            </div>

            <!-- Clear -->
            <div class="d-grid">
              <a href="{{ url_for('explore.index') }}"
                 class="btn"
                 style="background:#f6f7fb;border:1px solid #e5e7f2;">
                Clear filters
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Sincroniza el valor del buscador superior con la URL actual
  (function syncTopSearch(){
    const top = document.getElementById('search-query');
    if (!top) return;
    const q = new URLSearchParams(window.location.search).get('query') || '';
    top.value = q;
  })();

  // Construye URL con los filtros del panel derecho
  function navigateWithSideForm() {
    const form = document.getElementById('filters-side-form');
    if (!form) return;
    const params = new URLSearchParams(new FormData(form));

    // Asegura la presencia de query (vacía si procede)
    if (!params.has('query')) params.set('query', document.querySelector('#filters-side-form input[name="query"]')?.value || '');

    window.location = "{{ url_for('explore.index') }}?" + params.toString();
  }

  // Aplica filtros SOLO con Enter
  (function wireSideFilters(){
    const form = document.getElementById('filters-side-form');
    if (!form) return;

    form.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        navigateWithSideForm();
      }
    });

    // Botón "Clear filters" reactivo
    const clearBtn = form.querySelector('.btn-clear-filters');
    if (clearBtn) {
      clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        // Resetea campos visibles del panel
        form.reset();
        // Fuerza valores por defecto coherentes
        const sort = form.querySelector('select[name="sort_by"]');
        if (sort) sort.value = 'newest';
        const pub = form.querySelector('select[name="publication_type"]');
        if (pub) pub.value = 'any';
        const queryInput = form.querySelector('input[name="query"]');
        if (queryInput) queryInput.value = '';

        navigateWithSideForm();
      });
    }
  })();
</script>
{% endblock %}