{% extends "base_template.html" %}

{% block title %}Edit Dataset{% endblock %}

{% block content %}

<div class="row mb-3">
    <div class="col-12">
        <a href="{{ url_for('dataset.subdomain_index', doi=dataset.ds_meta_data.dataset_doi) }}" class="btn btn-outline-secondary btn-sm">
            <i data-feather="arrow-left" class="center-button-icon"></i>
            Back to dataset
        </a>
    </div>
</div>

<div class="row">
    <div class="col-xl-8 col-lg-12 col-md-12 col-sm-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i data-feather="edit-2" class="me-2"></i>
                    Edit Dataset Metadata
                </h4>
                <small class="text-muted">
                    Minor edits (title, description, tags) don't generate a new DOI version.
                </small>
            </div>
            <div class="card-body">
                <form id="editDatasetForm">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{{ dataset.ds_meta_data.title }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="5" required>{{ dataset.ds_meta_data.description }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="tags" class="form-label">Tags</label>
                        <input type="text" class="form-control" id="tags" name="tags" 
                               value="{{ dataset.ds_meta_data.tags or '' }}"
                               placeholder="Comma-separated tags (e.g., climate, temperature, 2024)">
                        <small class="text-muted">Separate multiple tags with commas</small>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('dataset.view_dataset_changelog', dataset_id=dataset.id) }}" 
                           class="btn btn-outline-info">
                            <i data-feather="clock" class="me-1"></i>
                            View Edit History
                        </a>
                        <button type="submit" class="btn btn-primary" id="saveBtn">
                            <i data-feather="save" class="me-1"></i>
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-12 col-md-12 col-sm-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Dataset Info</h5>
            </div>
            <div class="card-body">
                <p><strong>DOI:</strong><br>
                    <code>{{ dataset.ds_meta_data.dataset_doi }}</code>
                </p>
                <p><strong>Created:</strong><br>
                    {{ dataset.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                </p>
                <p><strong>Files:</strong><br>
                    {{ dataset.get_files_count() }} files ({{ dataset.get_file_total_size_for_human() }})
                </p>
                <hr>
                <a href="{{ url_for('dataset.view_dataset_versions', dataset_id=dataset.id) }}" 
                   class="btn btn-outline-secondary btn-sm w-100">
                    <i data-feather="git-branch" class="me-1"></i>
                    View Version History
                </a>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i data-feather="info" class="me-1"></i>
                    About Minor Edits
                </h6>
            </div>
            <div class="card-body">
                <p class="small mb-2">
                    <strong>Minor edits</strong> are changes to metadata that don't affect the dataset's scientific content:
                </p>
                <ul class="small mb-0">
                    <li>Title corrections</li>
                    <li>Description updates</li>
                    <li>Tag modifications</li>
                    <li>Author information</li>
                </ul>
                <p class="small mt-2 mb-0 text-muted">
                    These changes are tracked in the changelog but don't generate a new DOI.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('editDatasetForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('saveBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
    
    try {
        const formData = new FormData(this);
        const response = await fetch('{{ url_for("dataset.edit_dataset", dataset_id=dataset.id) }}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Show success message
            alert(data.message || 'Changes saved successfully!');
            if (data.changes > 0) {
                window.location.reload();
            }
        } else {
            alert('Error: ' + (data.message || 'Failed to save changes'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});
</script>

{% endblock %}

