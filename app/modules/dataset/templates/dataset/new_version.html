{% extends "base_template.html" %}

{% block title %}New Version{% endblock %}

{% block content %}

    <h1 class="h2 mb-3"><b>Create New Version</b> of: {{ dataset.ds_meta_data.title }}</h1>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_zenodo_connection_error" style="display: none">
                <div class="alert-message">

                    <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                        connection to the Zenodo API</h4>
                    <p class="p-0 m-0">
                        There seems to be some kind of problem with the Zenodo API and synchronization of your dataset
                        files may not be possible. We will save your files locally to eventually synchronize them with
                        Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                        anything about it.
                    </p>
                </div>
            </div>
        </div>
    </div>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="row">

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div id="basic_info_form">

                {{ form.hidden_tag() }}

                <div class="row">

                    <div class="col-12">

                        <h1 class="h3 mb-3">Basic info</h1>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-xs-12 col-md-12">
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }} *
                                    {{ form.title(class="form-control") }}
                                    {% for error in form.title.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.desc.label(class="form-label") }} *
                                    {{ form.desc(rows=4, class="form-control") }}
                                    {% for error in form.desc.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_type.label(class="form-label") }}
                                    {{ form.publication_type(class="form-control") }}
                                </div>
                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_doi.label(class="form-label") }}
                                    {{ form.publication_doi(class="form-control") }}
                                    {% for error in form.publication_doi.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-6">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-control") }}
                                    {% for error in form.tags.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-6">
                                <div class="mb-3">
                                    {{ form.version_number.label(class="form-label") }} *
                                    {{ form.version_number(class="form-control") }}
                                    {% for error in form.version_number.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                        </div>

                        <h1 class="h3 mb-3 mt-4">
                          Authors
                          <a href="#" data-toggle="modal" data-target="#infoModal">
                            <i data-feather="info"></i>
                          </a>
                        </h1>

                        <div class="modal fade" id="infoModal" ...>
                          </div>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author name</label>
                                <input class="form-control"
                                       disabled
                                       value="{{ current_user.profile.surname }}, {{ current_user.profile.name }}">
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <div id="authors">
                                        {% for subform in form.authors %}
                                        <div class="row author" ...>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn btn-secondary" id="add_author">Add author
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    {% if error %}
                        <div class="mt-3 col-lg-6 col-12">
                            <span style="color: red;">{{ error }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">

            <h1 class="h3 mb-3 mt-2">WeatherHub Files</h1>

            <div id="uploaded_models_form" style="padding-left: 2rem">
                <form action="{{ url_for('dataset.upload') }}" class="dropzone" id="myDropzone">
                    <div id="dropzone-text"></div>
                </form>

                <span class="text-danger" id="alerts" style="display: none">
                </span>

                <ul class="mt-2" id="file-list"></ul>

                <script>
                    const allowedExt = ['md', 'csv', 'txt'];
                    let dropzone = Dropzone.options.myDropzone = {
                        // ... (toda tu lógica de 'init', 'success', 'error' va aquí)
                    };
                </script>
            </div>
        </div>

    </div>

<div class="row" id="upload_dataset">

        <div class="col-12">
            <hr>
            <h1 class="h3 mb-3 mt-2">Publish Version</h1>
            <div style="padding-left: 2rem">

                <div class="mb-3 form-check">
                    {{ form.is_major_version(class="form-check-input") }}
                    {{ form.is_major_version.label(class="form-check-label") }}
                    <small class="form-text text-muted">{{ form.is_major_version.description }}</small>
                </div>

                <label class="form-check">
                    <input id="agreeCheckbox" class="form-check-input" type="checkbox" value="">
                    <span class="form-check-label" style="font-size: 15px">
                                I agree to have my feature models automatically uploaded...
                            </span>
                </label>

                <button id="upload_button" class="btn btn-primary mt-2">
                    <i data-feather="upload" class="center-button-icon"></i>
                    {{ form.submit.label }}
                </button>

                <div id="loading">
                    </div>
                </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('zenodo.scripts') }}"></script>
    <script src="{{ url_for('dataset.scripts') }}"></script>
{% endblock %}
